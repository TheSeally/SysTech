"use strict";

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var result = [{ "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "http://ecosned.ru/image/cache/catalog/categories/iz_fermerskogo_moloka/tvorog/7/ge-catalog-categories-iz_fermerskogo_moloka-tvorog-tvorozhnaya_massa_s_kuragoy-800x800.jpg", "prodName": "Творог 9% с курагой", "prodPrc": 121, "rowQnt": 45, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "https://www.utkonos.ru/images/photo/3265/3265004H.jpg", "prodName": "Молочный Яблоко 100", "prodPrc": 25.1, "rowQnt": 44, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "http://irecommend.ru/sites/default/files/imagecache/copyright1/user-images/299388/Ydfgl76IXe0nEM2gO6Ww.JPG", "prodName": "Молочный Традиция 100", "prodPrc": 115, "rowQnt": 62, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": null, "prodName": "Виноград 0,3л", "prodPrc": 65, "rowQnt": 87, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "https://mariupolcena.com/files/products/9ff44136e6ccb0afb404ad26f727e67d.jpeg", "prodName": "Русская картошка чедар 50", "prodPrc": 46.3, "rowQnt": 86, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "https://images.ua.prom.st/50389447_w640_h640_ncheskaya_s_grushej_200_g..jpg", "prodName": "Молочный Груша 200", "prodPrc": 180, "rowQnt": 80, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "https://www.utkonos.ru/images/photo/3054/3054289H.jpg", "prodName": "Аленка карамель 100г Акционный товар Большая скидка", "prodPrc": 73.9, "rowQnt": 94, "prodAvail": 0 }, { "docDate": "2017-10-16 12:07:07", "docType": "Расход", "docID": 564564867361367, "prodImg": "https://www.utkonos.ru/images/photo/3176/3176192H.jpg", "prodName": "Сыр 125г", "prodPrc": 131, "rowQnt": 83, "prodAvail": 0 }, { "docDate": "2017-10-16 15:09:08", "docType": "Расчет", "docID": 564564867361368, "prodImg": "http://карапузик.com.images.1c-bitrix-cdn.ru/upload/iblock/b28/b28f089d41db757b74cfebfe21609228.jpg", "prodName": "Яблоко-Виноград 0,5л", "prodPrc": 44, "rowQnt": 20, "prodAvail": 0 }, { "docDate": "2017-10-16 15:09:08", "docType": "Расчет", "docID": 564564867361368, "prodImg": "https://images.ua.prom.st/50389447_w640_h640_ncheskaya_s_grushej_200_g..jpg", "prodName": "Молочный Груша 200", "prodPrc": 180, "rowQnt": 65, "prodAvail": 0 }, { "docDate": "2017-10-16 15:09:08", "docType": "Расчет", "docID": 564564867361368, "prodImg": "http://ecosned.ru/image/cache/catalog/categories/iz_fermerskogo_moloka/tvorog/7/ge-catalog-categories-iz_fermerskogo_moloka-tvorog-tvorozhnaya_massa_s_kuragoy-800x800.jpg", "prodName": "Творог 9% с курагой", "prodPrc": 121, "rowQnt": 41, "prodAvail": 0 }, { "docDate": "2017-10-16 15:09:08", "docType": "Расчет", "docID": 564564867361368, "prodImg": "https://www.komus.ru/medias/sys_master/root/hd3/h93/9286922043422.jpg", "prodName": "Молочный Изюм 100", "prodPrc": 102, "rowQnt": 72, "prodAvail": 0 }, { "docDate": "2017-10-16 15:09:08", "docType": "Расчет", "docID": 564564867361368, "prodImg": null, "prodName": "Виноград 0,3л", "prodPrc": 65, "rowQnt": 39, "prodAvail": 0 }, { "docDate": "2017-10-16 18:11:09", "docType": "Приход", "docID": 564564867361369, "prodImg": "http://irecommend.ru/sites/default/files/imagecache/copyright1/user-images/299388/Ydfgl76IXe0nEM2gO6Ww.JPG", "prodName": "Молочный Традиция 100", "prodPrc": 115, "rowQnt": 60, "prodAvail": 0 }, { "docDate": "2017-10-16 18:11:09", "docType": "Приход", "docID": 564564867361369, "prodImg": "https://www.utkonos.ru/images/photo/3054/3054289H.jpg", "prodName": "Аленка карамель 100г Акционный товар Большая скидка", "prodPrc": 73.9, "rowQnt": 99, "prodAvail": 0 }, { "docDate": "2017-10-16 18:11:09", "docType": "Приход", "docID": 564564867361369, "prodImg": "https://mariupolcena.com/files/products/9ff44136e6ccb0afb404ad26f727e67d.jpeg", "prodName": "Русская картошка чедар 50", "prodPrc": 46.3, "rowQnt": 51, "prodAvail": 0 }, { "docDate": "2017-10-16 18:11:09", "docType": "Приход", "docID": 564564867361369, "prodImg": "https://www.utkonos.ru/images/photo/3117/3117496H.jpg", "prodName": "Русская картошка икра 50", "prodPrc": 33.1, "rowQnt": 15, "prodAvail": 0 }, { "docDate": "2017-11-01 12:09:03", "docType": "Приход", "docID": 564564867361360, "prodImg": "https://images.ua.prom.st/50389447_w640_h640_ncheskaya_s_grushej_200_g..jpg", "prodName": "Молочный Груша 200", "prodPrc": 180, "rowQnt": 96, "prodAvail": 0 }, { "docDate": "2017-11-01 12:09:03", "docType": "Приход", "docID": 564564867361360, "prodImg": null, "prodName": "Парус апельсин 1л", "prodPrc": 150, "rowQnt": 89, "prodAvail": 1 }, { "docDate": "2017-11-01 12:09:03", "docType": "Приход", "docID": 564564867361360, "prodImg": "https://www.utkonos.ru/images/photo/3265/3265004H.jpg", "prodName": "Молочный Яблоко 100", "prodPrc": 25.1, "rowQnt": 9, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "https://mariupolcena.com/files/products/9ff44136e6ccb0afb404ad26f727e67d.jpeg", "prodName": "Русская картошка чедар 50", "prodPrc": 46.3, "rowQnt": 62, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "http://produkty-online.ru/wa-data/public/shop/products/31/83/18331/images/1359/1359.970.jpg", "prodName": "Молочный Сказка 100", "prodPrc": 39, "rowQnt": 67, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "https://www.utkonos.ru/images/photo/3139/3139296H.jpg", "prodName": "Тоник 0,5л", "prodPrc": 63, "rowQnt": 51, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "https://www.komus.ru/medias/sys_master/root/hd3/h93/9286922043422.jpg", "prodName": "Молочный Изюм 100", "prodPrc": 102, "rowQnt": 4, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "http://ecosned.ru/image/cache/catalog/categories/iz_fermerskogo_moloka/tvorog/7/ge-catalog-categories-iz_fermerskogo_moloka-tvorog-tvorozhnaya_massa_s_kuragoy-800x800.jpg", "prodName": "Творог 9% с курагой", "prodPrc": 121, "rowQnt": 60, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": null, "prodName": "Виноград 0,3л", "prodPrc": 65, "rowQnt": 61, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361361, "prodImg": "http://xn--4-8sbu.xn--p1ai/thumb/4KQdJOhw0Uu5AnP0PPIrMQ/200r200/761268/3152.png", "prodName": "Беседа. 50гр", "prodPrc": 36.5, "rowQnt": 41, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "https://www.komus.ru/medias/sys_master/root/hd3/h93/9286922043422.jpg", "prodName": "Молочный Изюм 100", "prodPrc": 102, "rowQnt": 3, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "https://www.utkonos.ru/images/photo/3176/3176192H.jpg", "prodName": "Сыр 125г", "prodPrc": 131, "rowQnt": 96, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "https://www.utkonos.ru/images/photo/3139/3139296H.jpg", "prodName": "Тоник 0,5л", "prodPrc": 63, "rowQnt": 31, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": null, "prodName": "Парус лимон 1л", "prodPrc": 150, "rowQnt": 52, "prodAvail": 1 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "http://www.svoda.ru/site/userfiles/images/%D0%9A%D0%90%D0%9F%D0%9B%D0%AF%20%D0%A0%D0%9E%D0%A1%D0%AB%201.5%D0%9B%20%D0%93%D0%90%D0%97%D0%98%D0%A0%D0%9E%D0%92%D0%90%D0%9D%D0%9D%D0%90%D0%AF.jpg", "prodName": "Капля росы негаз 1.5л", "prodPrc": 16.9, "rowQnt": 16, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "http://www.calorizator.ru/sites/default/files/imagecache/product_512/product/tvorog-prostokvashino-1.jpg", "prodName": "Нежирный творог", "prodPrc": 52.41, "rowQnt": 81, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "http://ecosned.ru/image/cache/catalog/categories/iz_fermerskogo_moloka/tvorog/7/ge-catalog-categories-iz_fermerskogo_moloka-tvorog-tvorozhnaya_massa_s_kuragoy-800x800.jpg", "prodName": "Творог 9% с курагой", "prodPrc": 121, "rowQnt": 23, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "https://tashkentcena.com/files/products/893eebe7b69146290886dc504a3328ef.jpeg", "prodName": "Горький коньяк 100", "prodPrc": 336, "rowQnt": 52, "prodAvail": 0 }, { "docDate": "2017-11-03 13:11:06", "docType": "Приход", "docID": 564564867361362, "prodImg": "https://www.utkonos.ru/images/photo/3054/3054289H.jpg", "prodName": "Аленка карамель 100г Акционный товар Большая скидка", "prodPrc": 73.9, "rowQnt": 12, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "https://mariupolcena.com/files/products/9ff44136e6ccb0afb404ad26f727e67d.jpeg", "prodName": "Русская картошка чедар 50", "prodPrc": 46.3, "rowQnt": 3, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": null, "prodName": "Виноград 0,3л", "prodPrc": 65, "rowQnt": 88, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "http://www.calorizator.ru/sites/default/files/imagecache/product_512/product/tvorog-prostokvashino-1.jpg", "prodName": "Нежирный творог", "prodPrc": 52.41, "rowQnt": 20, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "https://www.utkonos.ru/images/photo/3139/3139296H.jpg", "prodName": "Тоник 0,5л", "prodPrc": 63, "rowQnt": 64, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "http://produkty-online.ru/wa-data/public/shop/products/31/83/18331/images/1359/1359.970.jpg", "prodName": "Молочный Сказка 100", "prodPrc": 39, "rowQnt": 54, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": null, "prodName": "Парус апельсин 1л", "prodPrc": 150, "rowQnt": 88, "prodAvail": 1 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "https://teremok.sm.ua/wa-data/public/shop/products/82/25/82582/images/35179/35179.750@2x.jpg", "prodName": "Сметана и лук 25г", "prodPrc": 30, "rowQnt": 33, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": "http://xn--4-8sbu.xn--p1ai/thumb/4KQdJOhw0Uu5AnP0PPIrMQ/200r200/761268/3152.png", "prodName": "Беседа. 50гр", "prodPrc": 36.5, "rowQnt": 6, "prodAvail": 0 }, { "docDate": "2017-11-29 17:26:57", "docType": "Приход", "docID": 564564867361365, "prodImg": null, "prodName": "Парус лимон 1л", "prodPrc": 150, "rowQnt": 65, "prodAvail": 1 }, { "docDate": "2017-11-29 18:29:00", "docType": "Расход", "docID": 564564867361364, "prodImg": "http://irecommend.ru/sites/default/files/imagecache/copyright1/user-images/299388/Ydfgl76IXe0nEM2gO6Ww.JPG", "prodName": "Молочный Традиция 100", "prodPrc": 115, "rowQnt": 64, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "https://mariupolcena.com/files/products/9ff44136e6ccb0afb404ad26f727e67d.jpeg", "prodName": "Русская картошка чедар 50", "prodPrc": 46.3, "rowQnt": 6, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "https://teremok.sm.ua/wa-data/public/shop/products/82/25/82582/images/35179/35179.750@2x.jpg", "prodName": "Сметана и лук 25г", "prodPrc": 30, "rowQnt": 18, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "http://xn--4-8sbu.xn--p1ai/thumb/4KQdJOhw0Uu5AnP0PPIrMQ/200r200/761268/3152.png", "prodName": "Беседа. 50гр", "prodPrc": 36.5, "rowQnt": 99, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "https://tashkentcena.com/files/products/893eebe7b69146290886dc504a3328ef.jpeg", "prodName": "Горький коньяк 100", "prodPrc": 336, "rowQnt": 94, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "https://www.utkonos.ru/images/photo/3176/3176192H.jpg", "prodName": "Сыр 125г", "prodPrc": 131, "rowQnt": 64, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": "https://www.utkonos.ru/images/photo/3265/3265004H.jpg", "prodName": "Молочный Яблоко 100", "prodPrc": 25.1, "rowQnt": 52, "prodAvail": 0 }, { "docDate": "2017-11-29 19:31:03", "docType": "Приход", "docID": 564564867361363, "prodImg": null, "prodName": "Парус апельсин 1л", "prodPrc": 150, "rowQnt": 43, "prodAvail": 1 }];

// Функция, производящая вычисление итоговой стоимости
function totalPrice(value) {
    if (value.prodAvail) {
        return 0;
    }
    return value.prodPrc * value.rowQnt;
}

// Функция для изменения формата даты
function getDate(date) {
    return new Date(date.split(" ")[0]).toLocaleString("ru", { month: 'long', day: 'numeric' });
}

// Функция для изменения дат в полученном json файле
var mappedResult = result.map(function (elem) {
    elem.docDate = getDate(elem.docDate);
    return elem;
});

// Функция для преобразования полученного json в структуру данных для шаблонизатора. На выходе объект, в котором ключи - даты, значения - объект, содержащий
// общую информацию о полученных в данный период документах, а также детализацию по товарам (разбитую по типу операций)
var modify = mappedResult.reduce(function (acc, value) {
    if (!(value.docDate in acc)) {
        var _acc$value$docDate;
        acc[value.docDate] = (_acc$value$docDate = {}, _defineProperty(_acc$value$docDate, value.docID, {
            items: [{ src: value.prodImg, price: value.prodPrc, name: value.prodName, avail: value.prodAvail, quant: value.rowQnt }],
            type: value.docType,
            count: 1,
            groupPrice: totalPrice(value)
        }), _defineProperty(_acc$value$docDate, "count", 1), _defineProperty(_acc$value$docDate, "documentPrice", totalPrice(value)), _acc$value$docDate);
        Object.defineProperty(acc[value.docDate], "count", { enumerable: false });
        Object.defineProperty(acc[value.docDate], "documentPrice", { enumerable: false });
        Object.defineProperty(acc[value.docDate][value.docID], "count", { enumerable: false });
        Object.defineProperty(acc[value.docDate][value.docID], "type", { enumerable: false });
        Object.defineProperty(acc[value.docDate][value.docID], "groupPrice", { enumerable: false });
    } else {
        if (!(value.docID in acc[value.docDate])) {
            acc[value.docDate][value.docID] = {
                items: [{ src: value.prodImg, price: value.prodPrc, name: value.prodName, avail: value.prodAvail, quant: value.rowQnt }],
                type: value.docType,
                count: 1,
                groupPrice: totalPrice(value)
            };
            acc[value.docDate]["count"] += 1;
            acc[value.docDate]["documentPrice"] += totalPrice(value);
        } else {
            var newItems = acc[value.docDate][value.docID]["items"];
            newItems.push({ src: value.prodImg, price: value.prodPrc, name: value.prodName, avail: value.prodAvail, quant: value.rowQnt });
            acc[value.docDate][value.docID] = {
                items: newItems,
                type: value.docType,
                count: acc[value.docDate][value.docID]["count"] + 1,
                groupPrice: acc[value.docDate][value.docID]["groupPrice"] + totalPrice(value)
            };
            Object.defineProperty(acc[value.docDate][value.docID], "count", { enumerable: false });
            Object.defineProperty(acc[value.docDate][value.docID], "type", { enumerable: false });
            Object.defineProperty(acc[value.docDate][value.docID], "groupPrice", { enumerable: false });
            acc[value.docDate]["count"] += 1;
            acc[value.docDate]["documentPrice"] += totalPrice(value);
        }
    }
    return acc;
}, {});

// Рендер шаблона из html
var template = document.getElementById('template').innerHTML;
var root = document.querySelector(".root");
var res = nunjucks.renderString(template, { modify: modify }, function (err, res) {
    return root.innerHTML = res;
});

// Функция, заменяющая не подгрузившиеся изображения
function noImage(elem) {
    elem.src = "./imgs/No_image_available.svg";
}

function hideElem(elem) {
    elem.classList.toggle("hide");
}